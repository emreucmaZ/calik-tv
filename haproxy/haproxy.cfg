global
    log stdout format raw local0 debug

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 10s
    timeout client 60s
    timeout server 60s

frontend https_in
    bind *:443
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }

    # Log SNI for debugging
    log-format "%ci:%cp [%t] %ft %b/%s sni:%[ssl_fc_sni]"

    acl is_rtmps req_ssl_sni -i media.gold4.me
    use_backend rtmps_backend if is_rtmps
    default_backend https_backend

backend rtmps_backend
    server stunnel calik-tv-stunnel:1936 check

backend https_backend
    server nginx nginx-proxy:443 check
